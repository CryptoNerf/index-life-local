<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>my day index</title>
  <meta property="og:title" content="index.life" />
  <meta property="og:description" content="mood book" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="{{ url_for('static', filename='images/android-chrome-512x512.png', _external=True) }}" />

  <!-- Основные favicon -->
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/favicon-16x16.png') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon-32x32.png') }}">

  <!-- iOS Safari (для добавления на рабочий стол iPhone) -->
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}">

  <!-- Android Chrome -->
  <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='images/android-chrome-192x192.png') }}">
  <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='images/android-chrome-512x512.png') }}">

  <!-- Web App Manifest (для PWA функций) -->
  <link rel="manifest" href="{{ url_for('static', filename='images/site.webmanifest') }}">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/edit_day.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tiptap-custom.css') }}">
  <script src="{{ url_for('static', filename='js/tiptap-bundle.js') }}"></script>
  <script src="{{ url_for('static', filename='js/tiptap-editor-init.js') }}"></script>
</head>
<body>
  <header class="main-header">
    <nav class="top-menu">
      <a href="{{ url_for('main.mood_grid') }}" class="menu-link index-link">index.life</a>
      <a href="{{ url_for('main.life_calendar') }}" class="menu-link">life in weeks</a>
      <a href="{{ url_for('main.account') }}" class="menu-link">account</a>
    </nav>
  </header>
  <div class="center-content">
    <h1 class="header" style="font-weight:normal;">my day index</h1>
    <p class="date-display">{{ day.strftime('%Y-%m-%d') }}</p>
    
    <!-- Error message display -->
    {% if get_flashed_messages(category_filter=['error']) %}
      <div class="error-message" style="margin-bottom: 20px; padding: 15px; background-color: #fee; border-left: 4px solid #f44; border-radius: 4px; color: #c00;">
        {% for message in get_flashed_messages(category_filter=['error']) %}
          <p style="margin: 5px 0;">{{ message }}</p>
        {% endfor %}
      </div>
    {% endif %}
    
    <form method="post" novalidate class="form-block" id="edit-form">
      <div class="cubes-row" id="rating-cubes">
        {% for i in range(1, 11) %}
          <span class="cube{% if entry and entry.rating >= i %} filled{% endif %}" data-value="{{ i }}"></span>
        {% endfor %}
      </div>
      <input type="hidden" name="rating" id="rating-input" value="{{ entry.rating if entry else '' }}">
      <div><p style="font-size:20px;">my day comment</p></div>
      <div class="textarea-block">
        <!-- Formatting toolbar -->
        <div class="formatting-toolbar">
          <button type="button" class="format-btn" data-format="bold" title="Bold (Ctrl+B)">
            <strong>B</strong>
          </button>
          <button type="button" class="format-btn" data-format="italic" title="Italic (Ctrl+I)">
            <em>I</em>
          </button>
          <button type="button" class="format-btn" data-format="h1" title="Heading 1">
            H1
          </button>
          <button type="button" class="format-btn" data-format="h2" title="Heading 2">
            H2
          </button>
          <button type="button" class="format-btn" data-format="h3" title="Heading 3">
            H3
          </button>
          <button type="button" class="format-btn" data-format="list" title="Bullet List">
            • List
          </button>
          <button type="button" class="format-btn" data-format="numbered" title="Numbered List">
            1. List
          </button>
          <button type="button" class="format-btn" data-format="link" title="Link">
            Link
          </button>
          <button type="button" class="format-btn" data-format="quote" title="Quote">
            "
          </button>
        </div>
        <!-- Hidden textarea for form submission -->
        <textarea name="note" id="note-textarea" class="note-textarea" rows="6" style="display: none;">{{ entry.note if entry else '' }}</textarea>
        <!-- Tiptap editor container -->
        <div id="tiptap-editor" class="tiptap-editor"></div>
      </div>
      <p style="font-size: 13px; color: #888; margin-bottom: 16px;">markdown supported</p>
      <button class="save-btn" type="submit">save</button>
    </form>
  </div>

  {% if entry %}
  <!-- Delete button (only show if entry exists) -->
  <div style="text-align: center; margin-top: 60px; margin-bottom: 20px;">
    <form id="delete-form" method="post" action="{{ url_for('main.delete_day', day=day.strftime('%Y-%m-%d')) }}" style="display: inline;">
      <button type="button" onclick="confirmDelete()" style="background: none; border: none; color: #999; font-size: 14px; cursor: pointer; text-decoration: none; padding: 8px;">
        kill a note
      </button>
    </form>
  </div>
  {% endif %}
  <script>
    function confirmDelete() {
      if (confirm('Are you sure you want to kill the note?')) {
        try {
          localStorage.removeItem(`draft:{{ day.strftime('%Y-%m-%d') }}`);
        } catch(e) {}
        document.getElementById('delete-form').submit();
      }
    }
  </script>
  <script>
    const cubes = document.querySelectorAll('.cube');
    const ratingInput = document.getElementById('rating-input');
    const editForm = document.getElementById('edit-form');
    let selected = parseInt(ratingInput.value) || 0;

    function fillCubes(count, className) {
      cubes.forEach((c, idx) => {
        c.classList.remove('filled', 'hovered');
        if (idx < count) c.classList.add(className);
      });
    }

    fillCubes(selected, 'filled');

    cubes.forEach((cube, idx) => {
      cube.addEventListener('mouseenter', function() {
        fillCubes(idx + 1, 'hovered');
      });
      cube.addEventListener('mouseleave', function() {
        fillCubes(selected, 'filled');
      });
      cube.addEventListener('click', function() {
        selected = idx + 1;
        ratingInput.value = selected;
        fillCubes(selected, 'filled');
      });
    });

    // Tiptap Editor Setup
    const noteTextarea = document.getElementById('note-textarea');
    const entryDate = "{{ day.strftime('%Y-%m-%d') }}";
    const draftKey = `draft:${entryDate}`;
    let tiptapEditor = null;

    // Draft management functions
    function loadDraft() {
      try {
        const raw = localStorage.getItem(draftKey);
        return raw ? JSON.parse(raw) : null;
      } catch (e) {
        return null;
      }
    }

    function saveDraft(markdown) {
      try {
        if (!markdown || !markdown.trim()) {
          localStorage.removeItem(draftKey);
          return;
        }
        localStorage.setItem(draftKey, JSON.stringify({
          content: markdown,
          updatedAt: Date.now()
        }));
      } catch (e) {
        // Ignore storage errors
      }
    }

    function clearDraft() {
      try {
        localStorage.removeItem(draftKey);
      } catch (e) {
        // Ignore
      }
    }

    let draftTimer = null;
    function scheduleDraftSave(markdown) {
      if (draftTimer) {
        clearTimeout(draftTimer);
      }
      draftTimer = setTimeout(() => saveDraft(markdown), 300);
    }

    // Load initial content or draft
    const initialContent = noteTextarea.value;
    const draft = loadDraft();
    let contentToLoad = initialContent;

    if (draft && draft.content) {
      if (draft.content === initialContent) {
        clearDraft();
      } else {
        contentToLoad = draft.content;
      }
    }

    // Initialize Tiptap editor
    tiptapEditor = window.TiptapEditorUtils.initTiptapEditor({
      elementId: 'tiptap-editor',
      placeholderText: 'Write your note here...',
      initialContent: contentToLoad,
      onUpdate: (markdown, editor) => {
        noteTextarea.value = markdown;
        scheduleDraftSave(markdown);
      }
    });

    // Setup toolbar buttons
    const toolbar = document.querySelector('.formatting-toolbar');
    if (tiptapEditor && toolbar) {
      window.TiptapEditorUtils.setupToolbarButtons(tiptapEditor, toolbar);
    }

    // Sync before form submission and clear draft
    editForm.addEventListener('submit', function() {
      if (tiptapEditor) {
        const markdown = window.TiptapEditorUtils.getMarkdownFromEditor(tiptapEditor);
        noteTextarea.value = markdown;
      }
      clearDraft();
    });


    // Form validation
    editForm.addEventListener('submit', function(e) {
      const rating = parseInt(ratingInput.value);
      if (!rating || rating < 1 || rating > 10) {
        e.preventDefault();
        
        // Remove previous error message if exists
        const existingError = document.querySelector('.form-error-message');
        if (existingError) {
          existingError.remove();
        }
        
        // Show error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'form-error-message';
        errorDiv.style.marginBottom = '20px';
        errorDiv.style.padding = '15px';
        errorDiv.style.backgroundColor = '#fee';
        errorDiv.style.borderLeft = '4px solid #f44';
        errorDiv.style.borderRadius = '4px';
        errorDiv.style.color = '#c00';
        errorDiv.innerHTML = '<p style="margin: 5px 0;">Please select your day mood rating (1-10) before saving</p>';
        
        const form = this;
        form.parentNode.insertBefore(errorDiv, form);
        
        // Scroll to error message
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        return false;
      }
    });
  </script>
</body>
</html>
