<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>my day index</title>
  <meta property="og:title" content="index.life" />
  <meta property="og:description" content="mood book" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="{{ url_for('static', filename='images/android-chrome-512x512.png', _external=True) }}" />

  <!-- Основные favicon -->
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/favicon-16x16.png') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon-32x32.png') }}">

  <!-- iOS Safari (для добавления на рабочий стол iPhone) -->
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}">

  <!-- Android Chrome -->
  <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='images/android-chrome-192x192.png') }}">
  <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='images/android-chrome-512x512.png') }}">

  <!-- Web App Manifest (для PWA функций) -->
  <link rel="manifest" href="{{ url_for('static', filename='images/site.webmanifest') }}">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/edit_day.css') }}">
  <script src="{{ url_for('static', filename='js/marked.umd.js') }}"></script>
  <script src="{{ url_for('static', filename='js/turndown.js') }}"></script>
</head>
<body>
  <header class="main-header">
    <nav class="top-menu">
      <a href="{{ url_for('main.mood_grid') }}" class="menu-link index-link">index.life</a>
      <a href="{{ url_for('main.account') }}" class="menu-link">account</a>
      <a href="{{ url_for('main.what_is_index') }}" class="menu-link">what is index.life?</a>
    </nav>
  </header>
  <div class="center-content">
    <h1 class="header" style="font-weight:normal;">my day index</h1>
    <p class="date-display">{{ day.strftime('%Y-%m-%d') }}</p>
    
    <!-- Error message display -->
    {% if get_flashed_messages(category_filter=['error']) %}
      <div class="error-message" style="margin-bottom: 20px; padding: 15px; background-color: #fee; border-left: 4px solid #f44; border-radius: 4px; color: #c00;">
        {% for message in get_flashed_messages(category_filter=['error']) %}
          <p style="margin: 5px 0;">{{ message }}</p>
        {% endfor %}
      </div>
    {% endif %}
    
    <form method="post" novalidate class="form-block" id="edit-form">
      <div class="cubes-row" id="rating-cubes">
        {% for i in range(1, 11) %}
          <span class="cube{% if entry and entry.rating >= i %} filled{% endif %}" data-value="{{ i }}"></span>
        {% endfor %}
      </div>
      <input type="hidden" name="rating" id="rating-input" value="{{ entry.rating if entry else '' }}">
      <div><p style="font-size:20px;">my day comment</p></div>
      <div class="textarea-block">
        <!-- Formatting toolbar -->
        <div class="formatting-toolbar">
          <button type="button" class="format-btn" data-format="bold" title="Bold (Ctrl+B)">
            <strong>B</strong>
          </button>
          <button type="button" class="format-btn" data-format="italic" title="Italic (Ctrl+I)">
            <em>I</em>
          </button>
          <button type="button" class="format-btn" data-format="h1" title="Heading 1">
            H1
          </button>
          <button type="button" class="format-btn" data-format="h2" title="Heading 2">
            H2
          </button>
          <button type="button" class="format-btn" data-format="h3" title="Heading 3">
            H3
          </button>
          <button type="button" class="format-btn" data-format="list" title="Bullet List">
            • List
          </button>
          <button type="button" class="format-btn" data-format="numbered" title="Numbered List">
            1. List
          </button>
          <button type="button" class="format-btn" data-format="link" title="Link">
            Link
          </button>
          <button type="button" class="format-btn" data-format="quote" title="Quote">
            "
          </button>
        </div>
        <!-- Hidden textarea for form submission -->
        <textarea name="note" class="note-textarea" rows="6" style="display: none;">{{ entry.note if entry else '' }}</textarea>
        <!-- WYSIWYG editor -->
        <div class="wysiwyg-editor" contenteditable="true" data-placeholder="Write your note here..."></div>
      </div>
      <p style="font-size: 13px; color: #888; margin-bottom: 16px;">markdown supported</p>
      <button class="save-btn" type="submit">save</button>
    </form>
  </div>

  {% if entry %}
  <!-- Delete button (only show if entry exists) -->
  <div style="text-align: center; margin-top: 60px; margin-bottom: 20px;">
    <form id="delete-form" method="post" action="{{ url_for('main.delete_day', day=day.strftime('%Y-%m-%d')) }}" style="display: inline;">
      <button type="button" onclick="confirmDelete()" style="background: none; border: none; color: #999; font-size: 14px; cursor: pointer; text-decoration: none; padding: 8px;">
        kill a note
      </button>
    </form>
  </div>
  {% endif %}
  <script>
    function confirmDelete() {
      if (confirm('Are you sure you want to kill the note?')) {
        document.getElementById('delete-form').submit();
      }
    }
  </script>
  <script>
    const cubes = document.querySelectorAll('.cube');
    const ratingInput = document.getElementById('rating-input');
    const editForm = document.getElementById('edit-form');
    let selected = parseInt(ratingInput.value) || 0;

    function fillCubes(count, className) {
      cubes.forEach((c, idx) => {
        c.classList.remove('filled', 'hovered');
        if (idx < count) c.classList.add(className);
      });
    }

    fillCubes(selected, 'filled');

    cubes.forEach((cube, idx) => {
      cube.addEventListener('mouseenter', function() {
        fillCubes(idx + 1, 'hovered');
      });
      cube.addEventListener('mouseleave', function() {
        fillCubes(selected, 'filled');
      });
      cube.addEventListener('click', function() {
        selected = idx + 1;
        ratingInput.value = selected;
        fillCubes(selected, 'filled');
      });
    });

    // WYSIWYG Editor
    const noteTextarea = document.querySelector('.note-textarea');
    const wysiwygEditor = document.querySelector('.wysiwyg-editor');
    const REMOVE_EMPTY_LINES = true;
    const hasMarked = typeof marked !== 'undefined';
    const hasTurndown = typeof TurndownService !== 'undefined';

    if (noteTextarea && wysiwygEditor) {
      if (hasMarked) {
        marked.setOptions({
          breaks: true,
          gfm: true
        });
      }

      // Initialize editor with existing content (render markdown to HTML)
      const initialContent = noteTextarea.value;
      const normalizedInitial = normalizeMarkdown(initialContent);
      if (normalizedInitial.trim()) {
        noteTextarea.value = normalizedInitial;
        if (hasMarked) {
          let html = marked.parse(normalizedInitial);

          // Clean up marked.js output: remove wrapper <p> tags if content is simple
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = html;

          // If there's only one <p> tag with no other block elements, unwrap it
          if (tempDiv.children.length === 1 && tempDiv.children[0].tagName === 'P') {
            // Check if the <p> contains only inline elements or text
            const p = tempDiv.children[0];
            let hasBlockElements = false;
            for (let child of p.children) {
              const tag = child.tagName.toLowerCase();
              if (['div', 'p', 'h1', 'h2', 'h3', 'ul', 'ol', 'blockquote'].includes(tag)) {
                hasBlockElements = true;
                break;
              }
            }
            if (!hasBlockElements) {
              html = p.innerHTML;
            }
          }

          wysiwygEditor.innerHTML = html;
          normalizeEditorDom(wysiwygEditor);

          // Make existing links clickable with Ctrl+Click
          wysiwygEditor.querySelectorAll('a').forEach(link => {
            link.setAttribute('target', '_blank');
            link.setAttribute('rel', 'noopener noreferrer');
          });
        } else {
          wysiwygEditor.textContent = normalizedInitial;
        }
      }

      // Handle clicks on links in editor (Ctrl/Cmd + Click to open)
      wysiwygEditor.addEventListener('click', function(e) {
        if (e.target.tagName === 'A') {
          if (e.ctrlKey || e.metaKey) {
            // Ctrl/Cmd + Click opens the link
            e.preventDefault();
            window.open(e.target.href, '_blank');
          } else {
            // Regular click - prevent navigation, allow editing
            e.preventDefault();
          }
        }
      });

      const turndownService = hasTurndown ? new TurndownService({
        headingStyle: 'atx',
        bulletListMarker: '-',
        codeBlockStyle: 'fenced',
        emDelimiter: '*',
        strongDelimiter: '**',
        br: '',
        blankReplacement: function() {
          return '';
        },
        defaultReplacement: function(content, node) {
          if (node.isBlock) {
            const cleaned = content.replace(/^\n+|\n+$/g, '');
            return cleaned ? cleaned + '\n' : '';
          }
          return content;
        }
      }) : null;

      if (turndownService) {
        turndownService.addRule('tightParagraphs', {
          filter: ['p', 'div'],
          replacement: function(content) {
            const cleaned = content.replace(/^\n+|\n+$/g, '');
            return cleaned ? cleaned + '\n' : '';
          }
        });

        turndownService.addRule('lineBreak', {
          filter: 'br',
          replacement: function() {
            return '\n';
          }
        });

        turndownService.addRule('strikethrough', {
          filter: ['del', 's', 'strike'],
          replacement: function(content) {
            return content ? '~~' + content + '~~' : '';
          }
        });

        turndownService.addRule('removeEmptyBlocks', {
          filter: function(node) {
            if (!node || node.nodeType !== 1) return false;
            const tag = node.tagName.toLowerCase();
            if (!['div', 'p', 'li', 'blockquote', 'ul', 'ol', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'].includes(tag)) {
              return false;
            }
            const text = node.textContent.replace(/[\u00a0\u200B-\u200D\uFEFF]/g, '').trim();
            if (text) return false;
            const hasNonBr = Array.from(node.childNodes).some(child => (
              child.nodeType === 1 && child.tagName.toLowerCase() !== 'br'
            ));
            return !hasNonBr;
          },
          replacement: function() {
            return '';
          }
        });
      }

      function stripInterBlockWhitespace(root) {
        const containers = [root, ...root.querySelectorAll('ul, ol, blockquote')];
        containers.forEach(container => {
          Array.from(container.childNodes).forEach(node => {
            if (node.nodeType === 3 && !node.textContent.trim()) {
              container.removeChild(node);
            }
          });
        });
      }

      function wrapRootInlineRuns(root) {
        const blockTags = new Set(['div', 'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ul', 'ol', 'li', 'blockquote', 'hr', 'pre']);
        const children = Array.from(root.childNodes);
        const hasBlock = children.some(node => (
          node.nodeType === 1 && blockTags.has(node.tagName.toLowerCase())
        ));

        if (!hasBlock) return;

        let buffer = [];
        function flushBuffer(beforeNode) {
          if (!buffer.length) return;
          const div = document.createElement('div');
          buffer.forEach(node => div.appendChild(node));
          root.insertBefore(div, beforeNode || null);
          buffer = [];
        }

        children.forEach(node => {
          if (node.nodeType === 3 && !node.textContent.trim()) {
            root.removeChild(node);
            return;
          }

          if (node.nodeType === 1 && blockTags.has(node.tagName.toLowerCase())) {
            flushBuffer(node);
            return;
          }

          buffer.push(node);
        });

        flushBuffer(null);
      }

      function convertTextNewlinesToBreaks(node) {
        const children = Array.from(node.childNodes);
        children.forEach(child => {
          if (child.nodeType === 3) {
            const text = child.nodeValue || '';
            if (!text.includes('\n')) return;

            const parts = text.split(/\n/);
            const frag = document.createDocumentFragment();

            parts.forEach((part, index) => {
              if (part) {
                frag.appendChild(document.createTextNode(part));
              }
              if (index < parts.length - 1) {
                frag.appendChild(document.createElement('br'));
              }
            });

            child.parentNode.replaceChild(frag, child);
            return;
          }

          if (child.nodeType === 1) {
            convertTextNewlinesToBreaks(child);
          }
        });
      }

      function normalizeEditorDom(root) {
        wrapRootInlineRuns(root);
        convertTextNewlinesToBreaks(root);
        stripInterBlockWhitespace(root);
      }

      function getNormalizedEditorHtml() {
        const clone = wysiwygEditor.cloneNode(true);
        normalizeEditorDom(clone);
        return clone.innerHTML;
      }

      function normalizeMarkdown(markdown) {
        let result = (markdown || '')
          .replace(/[\u200B-\u200D\uFEFF]/g, '')
          .replace(/\u00a0/g, ' ')
          .replace(/\r\n?/g, '\n');
        const lines = result.split('\n');
        let inCodeFence = false;

        const normalized = lines.map(line => {
          const scrubbedLine = line.replace(/[\u200B-\u200D\uFEFF]/g, '');
          line = scrubbedLine;
          const fenceMatch = line.match(/^\s*```/);
          if (fenceMatch) {
            inCodeFence = !inCodeFence;
            return line.trim();
          }

          if (inCodeFence) {
            return line.replace(/[ \t]+$/g, '');
          }

          if (!line.trim()) return '';

          if (line.trim().startsWith('>')) {
            const rest = line.replace(/^\s*>\s?/, '');
            return rest.trim() ? '> ' + rest.trim() : '>';
          }

          const listMatch = line.match(/^(\s*)(-|\d+\.)\s*(.*)$/);
          if (listMatch) {
            const indent = listMatch[1] || '';
            const marker = listMatch[2];
            const rest = listMatch[3].trim();
            return indent + marker + (rest ? ' ' + rest : '');
          }

          if (line.startsWith('  ')) {
            return '  ' + line.slice(2).trim();
          }

          return line.trim();
        });

        let output = [];
        let inFence = false;

        for (const line of normalized) {
          if (/^\s*```/.test(line)) {
            inFence = !inFence;
            output.push(line);
            continue;
          }

          if (inFence) {
            output.push(line);
            continue;
          }

          if (REMOVE_EMPTY_LINES) {
            if (line === '') continue;
            output.push(line);
            continue;
          }

          if (line === '') {
            if (output.length && output[output.length - 1] === '') continue;
            output.push('');
            continue;
          }

          output.push(line);
        }

        result = output.join('\n');
        result = result.replace(/[ \t]+\n/g, '\n');
        result = result.replace(/\n{3,}/g, '\n\n');
        return result.trim();
      }

      // Convert HTML to Markdown
      function htmlToMarkdown(html) {
        if (turndownService) {
          const raw = turndownService.turndown(html);
          return normalizeMarkdown(raw);
        }

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const fallback = tempDiv.textContent || '';
        return normalizeMarkdown(fallback);
      }

      function syncMarkdown() {
        const htmlContent = getNormalizedEditorHtml();
        const markdown = htmlToMarkdown(htmlContent);
        noteTextarea.value = markdown;

      }

      // Sync editor content to hidden textarea before form submission
      editForm.addEventListener('submit', function() {
        syncMarkdown();
      });

      // Sync content on any change (store as markdown)
      wysiwygEditor.addEventListener('input', function() {
        syncMarkdown();
      });
    }

    // Formatting toolbar functionality for WYSIWYG
    const formatBtns = document.querySelectorAll('.format-btn');

    function applyFormat(format) {
      wysiwygEditor.focus();

      // Check if heading/quote is already active - toggle it off
      if (format === 'h1' || format === 'h2' || format === 'h3' || format === 'quote') {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          let node = selection.anchorNode;

          // If text node, get parent element
          if (node.nodeType === 3) {
            node = node.parentNode;
          }

          // Find current block-level element
          while (node && node !== wysiwygEditor) {
            if (node.nodeType === 1) {
              const tagName = node.tagName.toUpperCase();

              // Toggle off if same format is clicked
              if ((format === 'h1' && tagName === 'H1') ||
                  (format === 'h2' && tagName === 'H2') ||
                  (format === 'h3' && tagName === 'H3') ||
                  (format === 'quote' && tagName === 'BLOCKQUOTE')) {
                document.execCommand('formatBlock', false, 'p');
                wysiwygEditor.dispatchEvent(new Event('input'));
                setTimeout(updateToolbarState, 10);
                return;
              }
            }
            node = node.parentNode;
          }
        }
      }

      switch(format) {
        case 'bold':
          document.execCommand('bold', false, null);
          break;
        case 'italic':
          document.execCommand('italic', false, null);
          break;
        case 'h1':
          document.execCommand('formatBlock', false, '<h1>');
          break;
        case 'h2':
          document.execCommand('formatBlock', false, '<h2>');
          break;
        case 'h3':
          document.execCommand('formatBlock', false, '<h3>');
          break;
        case 'list':
          document.execCommand('insertUnorderedList', false, null);
          break;
        case 'numbered':
          document.execCommand('insertOrderedList', false, null);
          break;
        case 'link':
          const selection = window.getSelection();
          const selectedText = selection.toString();

          if (!selectedText) {
            alert('Please select text first to create a link');
            return;
          }

          const url = prompt('Enter URL:', 'https://');
          if (url && url.trim()) {
            document.execCommand('createLink', false, url.trim());

            // Make sure links open in new tab and are styled properly
            setTimeout(() => {
              const links = wysiwygEditor.querySelectorAll('a[href="' + url.trim() + '"]');
              links.forEach(link => {
                link.setAttribute('target', '_blank');
                link.setAttribute('rel', 'noopener noreferrer');
              });
            }, 10);
          }
          break;
        case 'quote':
          document.execCommand('formatBlock', false, '<blockquote>');
          break;
      }

      // Trigger input event to sync with hidden textarea
      wysiwygEditor.dispatchEvent(new Event('input'));
    }

    formatBtns.forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const format = this.dataset.format;
        applyFormat(format);
      });
    });

    // Keyboard shortcuts
    wysiwygEditor.addEventListener('keydown', function(e) {
      if (e.ctrlKey || e.metaKey) {
        if (e.key === 'b') {
          e.preventDefault();
          applyFormat('bold');
        } else if (e.key === 'i') {
          e.preventDefault();
          applyFormat('italic');
        }
      }
    });

    // Update toolbar button states based on cursor position
    function updateToolbarState() {
      // Check for bold
      const isBold = document.queryCommandState('bold');
      const boldBtn = document.querySelector('[data-format="bold"]');
      if (boldBtn) {
        boldBtn.classList.toggle('active-format', isBold);
      }

      // Check for italic
      const isItalic = document.queryCommandState('italic');
      const italicBtn = document.querySelector('[data-format="italic"]');
      if (italicBtn) {
        italicBtn.classList.toggle('active-format', isItalic);
      }

      // Check for lists
      const isUL = document.queryCommandState('insertUnorderedList');
      const ulBtn = document.querySelector('[data-format="list"]');
      if (ulBtn) {
        ulBtn.classList.toggle('active-format', isUL);
      }

      const isOL = document.queryCommandState('insertOrderedList');
      const olBtn = document.querySelector('[data-format="numbered"]');
      if (olBtn) {
        olBtn.classList.toggle('active-format', isOL);
      }

      // Check for heading levels and blockquote
      const selection = window.getSelection();

      // Reset all heading and quote buttons first
      document.querySelectorAll('[data-format="h1"], [data-format="h2"], [data-format="h3"], [data-format="quote"]').forEach(btn => {
        btn.classList.remove('active-format');
      });

      if (selection.rangeCount > 0) {
        let node = selection.anchorNode;

        // Traverse up to find block-level element
        while (node && node !== wysiwygEditor) {
          if (node.nodeType === 1) { // Element node
            const tagName = node.tagName;

            // Activate corresponding button
            if (tagName === 'H1') {
              const h1Btn = document.querySelector('[data-format="h1"]');
              if (h1Btn) h1Btn.classList.add('active-format');
              break;
            } else if (tagName === 'H2') {
              const h2Btn = document.querySelector('[data-format="h2"]');
              if (h2Btn) h2Btn.classList.add('active-format');
              break;
            } else if (tagName === 'H3') {
              const h3Btn = document.querySelector('[data-format="h3"]');
              if (h3Btn) h3Btn.classList.add('active-format');
              break;
            } else if (tagName === 'BLOCKQUOTE') {
              const quoteBtn = document.querySelector('[data-format="quote"]');
              if (quoteBtn) quoteBtn.classList.add('active-format');
              break;
            }
          }
          node = node.parentNode;
        }
      }
    }

    // Update toolbar on selection change or click
    wysiwygEditor.addEventListener('mouseup', updateToolbarState);
    wysiwygEditor.addEventListener('keyup', updateToolbarState);
    wysiwygEditor.addEventListener('focus', updateToolbarState);

    // Update after applying format
    const originalApplyFormat = applyFormat;
    applyFormat = function(format) {
      originalApplyFormat(format);
      setTimeout(updateToolbarState, 10);
    };

    // Form validation
    editForm.addEventListener('submit', function(e) {
      const rating = parseInt(ratingInput.value);
      if (!rating || rating < 1 || rating > 10) {
        e.preventDefault();
        
        // Remove previous error message if exists
        const existingError = document.querySelector('.form-error-message');
        if (existingError) {
          existingError.remove();
        }
        
        // Show error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'form-error-message';
        errorDiv.style.marginBottom = '20px';
        errorDiv.style.padding = '15px';
        errorDiv.style.backgroundColor = '#fee';
        errorDiv.style.borderLeft = '4px solid #f44';
        errorDiv.style.borderRadius = '4px';
        errorDiv.style.color = '#c00';
        errorDiv.innerHTML = '<p style="margin: 5px 0;">Please select your day mood rating (1-10) before saving</p>';
        
        const form = this;
        form.parentNode.insertBefore(errorDiv, form);
        
        // Scroll to error message
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        return false;
      }
    });
  </script>
</body>
</html>
