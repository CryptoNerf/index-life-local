name: Build Multi-Platform Releases

on:
  release:
    types: [created]
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

permissions:
  contents: write  # Required for uploading release assets

jobs:
  build-windows:
    name: Build Windows .exe
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Windows executable
        run: |
          python -m PyInstaller build.spec --clean

      - name: Create zip archive
        run: |
          Compress-Archive -Path dist\index-life\* -DestinationPath index-life_windows_x64.zip

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: index-life_windows_x64.zip

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: index-life_windows_x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS .app
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install -r requirements.txt
          pip3 install pyinstaller

      - name: Build macOS .app bundle
        run: |
          python3 -m PyInstaller build_macos.spec --clean

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG image
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ DMG Ð¾Ð±Ñ€Ð°Ð·
          create-dmg \
            --volname "index.life" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "index.life.app" 175 190 \
            --hide-extension "index.life.app" \
            --app-drop-link 425 190 \
            --no-internet-enable \
            "index-life_macos.dmg" \
            "dist/"

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: index-life_macos.dmg

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: index-life_macos.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux AppImage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2 file

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install -r requirements.txt
          pip3 install pyinstaller

      - name: Build Linux executable
        run: |
          python3 -m PyInstaller build.spec --clean

      - name: Download appimagetool
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Create AppImage structure
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ AppDir
          mkdir -p index-life.AppDir/usr/bin
          cp -r dist/index-life/* index-life.AppDir/usr/bin/

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ÐºÐ¾Ð½ÐºÑƒ
          cp app/static/images/icon.png index-life.AppDir/index-life.png
          cp app/static/images/icon.png index-life.AppDir/.DirIcon

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ .desktop Ñ„Ð°Ð¹Ð»
          cat > index-life.AppDir/index-life.desktop << 'EOF'
          [Desktop Entry]
          Name=index.life
          Exec=index-life
          Icon=index-life
          Type=Application
          Categories=Utility;
          Comment=Private mood tracking diary
          Terminal=false
          EOF

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ AppRun ÑÐºÑ€Ð¸Ð¿Ñ‚
          cat > index-life.AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin/:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          cd "${HERE}/usr/bin"
          exec "${HERE}/usr/bin/index-life" "$@"
          EOF
          chmod +x index-life.AppDir/AppRun

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ
          ls -la index-life.AppDir/
          ls -la index-life.AppDir/usr/bin/

      - name: Build AppImage
        run: |
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ verbose Ð²Ñ‹Ð²Ð¾Ð´Ð¾Ð¼
          ARCH=x86_64 ./appimagetool-x86_64.AppImage --appimage-extract-and-run --verbose index-life.AppDir index-life_linux_x86_64.AppImage || {
            echo "AppImage build failed, trying without FUSE..."
            ./appimagetool-x86_64.AppImage --appimage-extract
            ./squashfs-root/AppRun index-life.AppDir index-life_linux_x86_64.AppImage
          }

      - name: Verify and prepare AppImage
        run: |
          if [ -f index-life_linux_x86_64.AppImage ]; then
            chmod +x index-life_linux_x86_64.AppImage
            ls -lh index-life_linux_x86_64.AppImage
            echo "âœ… AppImage created successfully!"
          else
            echo "âŒ AppImage file not found!"
            exit 1
          fi

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: index-life_linux_x86_64.AppImage

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: index-life_linux_x86_64.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-release-notes:
    name: Update Release Notes
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos, build-linux]
    if: github.event_name == 'release'

    steps:
      - name: Update Release Description
        uses: softprops/action-gh-release@v1
        with:
          append_body: true
          body: |

            ---

            ## ðŸ“¦ Downloads

            ### ðŸªŸ Windows
            Download `index-life_windows_x64.zip`, unzip and run `index-life.exe`

            ### ðŸŽ macOS
            Download `index-life_macos.dmg`, open it and drag to Applications

            ### ðŸ§ Linux
            Download `index-life_linux_x86_64.AppImage`, make executable and run:
            ```bash
            chmod +x index-life_linux_x86_64.AppImage
            ./index-life_linux_x86_64.AppImage
            ```

            ---

            ðŸ¤– *Built automatically with GitHub Actions*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
