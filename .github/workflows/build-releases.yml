name: Build Multi-Platform Releases

on:
  release:
    types: [created]
  workflow_dispatch:  # Позволяет запускать вручную

permissions:
  contents: write  # Required for uploading release assets

jobs:
  build-windows:
    name: Build Windows .exe
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Windows executable
        run: |
          python -m PyInstaller build.spec --clean

      - name: Create zip archive
        run: |
          Compress-Archive -Path dist\index-life\* -DestinationPath index-life_windows_x64.zip

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: index-life_windows_x64.zip

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: index-life_windows_x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS .app
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install -r requirements.txt
          pip3 install pyinstaller

      - name: Build macOS .app bundle
        run: |
          python3 -m PyInstaller build_macos.spec --clean

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG image
        run: |
          # Создаём DMG образ
          create-dmg \
            --volname "index.life" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "index.life.app" 175 190 \
            --hide-extension "index.life.app" \
            --app-drop-link 425 190 \
            --no-internet-enable \
            "index-life_macos.dmg" \
            "dist/"

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: index-life_macos.dmg

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: index-life_macos.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux AppImage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2 file

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install -r requirements.txt
          pip3 install pyinstaller

      - name: Build Linux executable
        run: |
          python3 -m PyInstaller build.spec --clean

      - name: Download appimagetool
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Create AppImage structure
        run: |
          # Создаём структуру AppDir
          mkdir -p index-life.AppDir/usr/bin
          cp -r dist/index-life/* index-life.AppDir/usr/bin/

          # Копируем иконку
          cp app/static/images/icon.png index-life.AppDir/index-life.png
          cp app/static/images/icon.png index-life.AppDir/.DirIcon

          # Создаём .desktop файл
          cat > index-life.AppDir/index-life.desktop << 'EOF'
          [Desktop Entry]
          Name=index.life
          Exec=index-life
          Icon=index-life
          Type=Application
          Categories=Utility;
          Comment=Private mood tracking diary
          Terminal=false
          EOF

          # Создаём AppRun скрипт
          cat > index-life.AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin/:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          cd "${HERE}/usr/bin"
          exec "${HERE}/usr/bin/index-life" "$@"
          EOF
          chmod +x index-life.AppDir/AppRun

          # Проверяем структуру
          ls -la index-life.AppDir/
          ls -la index-life.AppDir/usr/bin/

      - name: Build AppImage
        run: |
          # Запускаем с verbose выводом
          ARCH=x86_64 ./appimagetool-x86_64.AppImage --appimage-extract-and-run --verbose index-life.AppDir index-life_linux_x86_64.AppImage || {
            echo "AppImage build failed, trying without FUSE..."
            ./appimagetool-x86_64.AppImage --appimage-extract
            ./squashfs-root/AppRun index-life.AppDir index-life_linux_x86_64.AppImage
          }

      - name: Verify and prepare AppImage
        run: |
          if [ -f index-life_linux_x86_64.AppImage ]; then
            chmod +x index-life_linux_x86_64.AppImage
            ls -lh index-life_linux_x86_64.AppImage
            echo "AppImage created successfully!"
          else
            echo "AppImage file not found!"
            exit 1
          fi

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: index-life_linux_x86_64.AppImage

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: index-life_linux_x86_64.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-vulkan-wheel-windows:
    name: Build Vulkan wheel (Windows)
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Vulkan SDK
        uses: humbletim/setup-vulkan-sdk@v1.2.0
        with:
          vulkan-query-version: latest
          vulkan-components: Vulkan-Headers, Vulkan-Loader, Glslang
          vulkan-use-cache: true

      - name: Build llama-cpp-python wheel with Vulkan
        run: |
          python -m pip install --upgrade pip setuptools wheel cmake scikit-build-core[pyproject]
          $env:CMAKE_ARGS = "-DGGML_VULKAN=ON -DLLAMA_CURL=OFF"
          $env:FORCE_CMAKE = "1"
          pip wheel llama-cpp-python==0.3.15 --no-deps --no-cache-dir --no-build-isolation -w wheelhouse/

      - name: List built wheels
        run: |
          Get-ChildItem wheelhouse/

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: vulkan-wheel-windows
          path: wheelhouse/*.whl

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: wheelhouse/*.whl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-vulkan-wheel-linux:
    name: Build Vulkan wheel (Linux)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Vulkan SDK
        uses: humbletim/setup-vulkan-sdk@v1.2.0
        with:
          vulkan-query-version: latest
          vulkan-components: Vulkan-Headers, Vulkan-Loader, Glslang
          vulkan-use-cache: true

      - name: Install system build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Build llama-cpp-python wheel with Vulkan
        env:
          CMAKE_ARGS: "-DGGML_VULKAN=ON -DLLAMA_CURL=OFF"
          FORCE_CMAKE: "1"
        run: |
          python3 -m pip install --upgrade pip setuptools wheel cmake scikit-build-core[pyproject]
          pip wheel llama-cpp-python==0.3.15 --no-deps --no-cache-dir --no-build-isolation -w wheelhouse/

      - name: List built wheels
        run: ls -lh wheelhouse/

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: vulkan-wheel-linux
          path: wheelhouse/*.whl

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: wheelhouse/*.whl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-release-notes:
    name: Update Release Notes
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos, build-linux, build-vulkan-wheel-windows, build-vulkan-wheel-linux]
    if: github.event_name == 'release'

    steps:
      - name: Update Release Description
        uses: softprops/action-gh-release@v1
        with:
          append_body: true
          body: |

            ---

            ## Downloads

            ### Windows
            Download `index-life_windows_x64.zip`, unzip and run `index-life.exe`

            ### macOS
            Download `index-life_macos.dmg`, open it and drag to Applications

            ### Linux
            Download `index-life_linux_x86_64.AppImage`, make executable and run:
            ```bash
            chmod +x index-life_linux_x86_64.AppImage
            ./index-life_linux_x86_64.AppImage
            ```

            ### AI Assistant (GPU acceleration)
            Vulkan wheels for GPU acceleration are included in this release.
            Run `install_modules.bat --module assistant --profile auto` to install automatically.

            ---

            *Built automatically with GitHub Actions*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
